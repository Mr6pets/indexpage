# =============================
# 子域：elevatorcalc（电梯报价）
# =============================
server {
    listen 80;
    server_name elevatorcalc.guluwater.com;
    # 强制跳转 HTTPS
    return 301 https://$host$request_uri;
}

# =============================
# 子域：elevatorcalc（电梯报价）- HTTPS
# =============================
server {
    listen 443 ssl http2;
    server_name elevatorcalc.guluwater.com;

    # 关键：必须使用为 elevatorcalc.guluwater.com 这个子域名单独申请的证书
    ssl_certificate     /etc/pki/cert/elevatorcalc.guluwater.com.pem;
    ssl_certificate_key /etc/pki/cert/elevatorcalc.guluwater.com.key;

    # 可选：复用主站的SSL优化配置，提升安全性
    ssl_session_cache   shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # Gzip Compression
    gzip on;
    gzip_types application/json;
    gzip_min_length 1000;

    # 网站根目录
    root /home/elevatorcalc;
    index index.html;

    # SPA 路由支持（防止刷新 404）
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 子路径 /calc 提供 H5 构建页面
    location /calc/ {
        alias /home/elevatorcalc/calc/;
        index index.html;
        try_files $uri $uri/ /calc/index.html;
    }

    # H5 静态模板与资源（/static/）映射到子目录
    location ^~ /static/ {
        alias /home/elevatorcalc/calc/static/;
        # 模板文件通常不缓存，避免替换后读取旧版本
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
        expires -1;
    }

    # Admin SPA 映射到 /home/elevatorcalc/admin_web
    location = /admin {
        return 302 /admin/;
    }
    location ^~ /admin/ {
        alias /home/elevatorcalc/admin_web/;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
    location ^~ /admin/assets/ {
        alias /home/elevatorcalc/admin_web/assets/;
        expires 30d;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # 将 /inspection_json 映射到静态资源目录，保证旧接口地址可用
    # 使用 ^~ 提高优先级，防止被下方的正则 location (json) 抢占
    location ^~ /inspection_json/ {
        alias /home/elevatorcalc/static/inspection_json/;
        add_header Access-Control-Allow-Origin *;
        # JSON 数据文件禁止缓存，确保数据更新
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
        expires -1;
    }

    # API 接口反向代理到 Python 后端
    location /api/ {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 1. 针对 HTML 和 JSON 文件：禁止缓存 (确保入口和数据总是最新的)
    location ~* \.(html|json)$ {
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
        expires -1;
    }

    # 2. 针对静态资源 (JS, CSS, Images)：开启长期缓存 (这些文件构建时通常带hash，适合缓存)
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
}

# 子域：h5.elevatorcalc.guluwater.com（H5 页面）
server {
    listen 80;
    server_name h5.elevatorcalc.guluwater.com;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    server_name h5.elevatorcalc.guluwater.com;

    ssl_certificate     /etc/pki/cert/h5.elevatorcalc.guluwater.com.pem;
    ssl_certificate_key /etc/pki/cert/h5.elevatorcalc.guluwater.com.key;

    ssl_session_cache   shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    gzip on;
    gzip_types application/json;
    gzip_min_length 1000;

    # 将根路径重定向到 /calc/，匹配前端构建的 base=/calc/
    location = / {
        return 302 /calc/;
    }

    # 映射 /calc/ 到构建目录，并启用 SPA 回退
    location ^~ /calc/ {
        alias /home/elevatorcalc/calc/;
        index index.html;
        try_files $uri $uri/ /calc/index.html;
    }

    location ~* \.(html|json)$ {
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
        expires -1;
    }

    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # 静态模板与资源
    location ^~ /static/ {
        alias /home/elevatorcalc/calc/static/;
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
        expires -1;
    }

    # 后端 API 反向代理（与主域一致）
    location /api/ {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 预览上传接口（用于在线预览生成 docx）
    location /preview/ {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
